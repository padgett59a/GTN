@model IEnumerable<GlobalTeamNetwork.Models.SemesterCoreCName>

@{
    ViewData["Title"] = "SemesterCores";
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Semester Cores</title>
</head>
<body>
    <h1>Semester Cores</h1>

    @*Filtering*@
    <table>
        <tr>
            <td nowrap>
                filtered&nbsp;for&nbsp;Curriculum&nbsp;<select id="currFilter" style="width:300px;">
                    <option value="??">All</option>
                </select>&nbsp;&nbsp;&nbsp;<a id="showAllRows" href="javascript:void(0)">Show All</a>

            </td>
        </tr>
    </table><br>

    <p>
        <a id="createNew" href="javascript:void(0)">Add New Semester Core</a>
        <!--     <button id="createNew">Add Semester Core</button> -->
    </p>
    @*<table id="tblMain" class="table">*@
    <table id="tblMain" class="table table-bordered table-hover table-striped">
            <thead>
                <!-- Top Labels-->
                <tr>
                    <th class="columnSort">
                        @Html.DisplayNameFor(model => model.SemesterCode)&nbsp;<span class="nobreak sortArrow">&#8593;&#8595;</span>
                    </th>
                    <th class="columnSort">
                        @Html.DisplayNameFor(model => model.SemesterName)&nbsp;<span class="nobreak sortArrow">&#8593;&#8595;</span>
                    </th>
                    <th class="columnSort">
                        @Html.DisplayNameFor(model => model.CurriculumName)&nbsp;<span class="nobreak sortArrow">&#8593;&#8595;</span>
                    </th>
                    <th class="columnSort">
                        @Html.DisplayNameFor(model => model.NumberOfVideoSessions)&nbsp;<span class="nobreak sortArrow">&#8593;&#8595;</span>
                    </th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr id="@(" tr" + @item.SemesterCode)">
                        <td class="semesterCode">
                            @Html.DisplayFor(modelItem => item.SemesterCode)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.SemesterName)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.CurriculumName)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.NumberOfVideoSessions)
                        </td>
                        <td>
                            <a onclick="editItem('@item.SemesterCode', this)" href="javascript:void(0)" id="@item.SemesterCode">Edit</a> |
                            <a asp-controller="Cores" asp-action="SemesterCoreDetail" asp-route-id="@item.SemesterCode">Details</a> |
                            <a onclick="deleteItem('@item.SemesterCode', this)" href="javascript:void(0)" id="@item.SemesterCode">Delete</a>
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot hidden>
                <!-- Bottom Labels-->
                <tr class="bottomLabels>
                    <th>
                        @Html.DisplayNameFor(model => model.SemesterCode)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.SemesterName)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.CurriculumName)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.NumberOfVideoSessions)
                    </th>
                    <th></th>
                </tr>
                @*input controls for adding a new item*@
                <tr>
                    <td><input type="text" id="txtSemesterCode" class="semInputClass" /></td>
                    <td><input type="text" id="txtSemesterName" class="semInputClass" /></td>
                    <td id="currDDL"><input type="text" id="txtCurriculumID" class="semInputClass" /></td>
                    <td><input type="text" id="txtNumberOfVideoSessions" class="semInputClass" /></td>
                    <td id="tdBtnCell"><input type="button" id="btnAdd" value="Add" />&nbsp;&nbsp;&nbsp;&nbsp;<input type="button" id="btnCancel" value="Cancel" /></td>
                </tr>
                <tr id="trSaveAll">
                    <td>
                        <input type="button" disabled id="btnSave" value="Save All" />&nbsp;&nbsp;&nbsp;
                        <input type="button" id="btnCancel" value="Cancel" />
                    </td>
                    <td colspan="100%"></td>
                </tr>
            </tfoot>
        </table>
        <p>
            <a id="createNew2" href="javascript:void(0)">Add New Semester Core</a>
            <!--     <button id="createNew">Add Semester Core</button> -->
        </p>

        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script type="text/javascript" src="http://ajax.cdnjs.com/ajax/libs/json2/20110223/json2.js"></script>

        <script type="text/javascript">

    //NOTE: common js functions are found in wwwroot/js/ViewCommon.js

    //scope functions declared inside of document.ready
    var editItem;
    var deleteItem;

    $(document).ready(function () {

        //pFilter is passed to the page via query string for page refresh, etc.
        var pFilter = (new URL(location.href)).searchParams.get('filter');

        $("#showAllRows").click(function () {
            //Set filter to 'All'
            $('#semFilter').prop('selectedIndex', 0).change();
        });


        //Get the curriculum from the db via ajax
        var curriculum;
        var curriculumTextArray = ['0th item'];
        var delayMils = 900;
        var pageOjectLabel = 'SemesterCore';

        //see if the candidate semester code already exists
        function semesterCodeExists(testCode) {
            var codeMatch = $("td.semesterCode").filter(function () {
                return $(this).html().trim().toUpperCase() == testCode.toUpperCase();
            });

            if (codeMatch.length > 0)
            { return true;}
            else
            {
                return false;
            }
        }

        //Set up curriculum add drop down
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetCurriculumJson","Cores")',
            dataType: "json",
            async: false,
            success: function (response) {
                curriculum = response;
            }
        });


        //var ddlCode =
        //    '<select id = "curriculumDDL" name = "curriculumDDL"> '
        //    for (i = 0; i < curriculum.length; i++) {
        //        ddlCode += '<option value=' + curriculum[i].CurriculumID + '>' + curriculum[i].CurriculumName + '</option >';
        //        curriculumTextArray.push(curriculum[i].CurriculumName);
        //    }
        //    ddlCode += '</select >';


        //set up curriculum ddlCode and filter values
        var ddlCode = '<select id = "curriculumDDL" name = "curriculumDDL"> '
        ddlCode += "<option value='??'>None Selected</option>";
        for (var key in curriculum) {
            ddlCode += "<option value='" + curriculum[key].curriculumID + "'>" + curriculum[key].CurriculumName + "</option>";
            $('#currFilter').append($('<option>', {
                value: curriculum[key].curriculumID,
                text: curriculum[key].CurriculumName
            }));
        }
        ddlCode += '</select >';

        $('#currFilter').change(function () {
            var curriculumFilter = this.options[this.selectedIndex].text;
            if (curriculumFilter != "All") {
                $("#tblMain td:nth-child(3):contains('" + curriculumFilter + "')").parent().show();
                $("#tblMain td:nth-child(3):not(:contains('" + curriculumFilter + "'))").parent().hide();
            }
            else {
                //show all rows
                $("#tblMain tr").show();
            }
            $("#tblMain TFOOT").attr("hidden", true);

        })

        function refreshMe() {
            //Refresh the page
            var url = '@Url.Action("SemesterCores", "Cores")' + "?filter=" + $('#currFilter option').filter(':selected').val();
            window.location.href = url;
        }


        $("body").on("click", "#btnCancel", function () {
            //Refresh the page
            refreshMe();
        });

        $("[id^=createNew]").click(function () {
            //Set up add button
            changeSaveButton(buttonType.ADD, 0);
            $("#currDDL").html(ddlCode);

            //show footer
            $('#txtSemesterCode').prop('disabled', false);
            $("#tblMain TFOOT").attr("hidden", false);
            //scroll to bottom
            $("html, body").animate({ scrollTop: $(document).height() }, 1000);
        });

        // Add another item
        $("body").on("click", "#btnAdd", function () {
            //Reference the Name and Country TextBoxes.
            var txt01 = $("#txtSemesterCode");
            var txt02 = $("#txtSemesterName");
            //var txt03 = $("#txtCurriculumID");
            var selCurr = $("#curriculumDDL");
            var curriculumText = $('#curriculumDDL option:selected').text();
            var txt04 = $("#txtNumberOfVideoSessions");

            if (txt01.val().length == 0 ||
                txt02.val().length == 0 ||
                //txt03.val().length == 0 ||
                txt04.val().length == 0) {
                alert("Please enter all " + pageOjectLabel + " data before proceeding.");
            }
            else if (!digitsOnly(txt04.val())) {
                alert("The Number Of Video Sessions must be number. Please correct this before proceeding.");
            }
            else if (semesterCodeExists(txt01.val()) ) {
                alert("Semester Codes must be unique. Please correct this before proceeding.");
            }
            else {
                //Get the reference of the Table's TFOOT element.
                var tFoot = $("#tblMain > TFOOT")[0];

                //Add Row.
                var row = tFoot.insertRow(0);

                //Add txtSemesterCode cell.
                var cell = $(row.insertCell(-1));
                cell.html(txt01.val());

                //Add txtSemesterName cell.
                cell = $(row.insertCell(-1));
                cell.html(txt02.val());

                //Add txtCurriculumName cell.
                cell = $(row.insertCell(-1));
                cell.html(curriculumText);

                //Add txtNumberOfVideoSessions cell.
                cell = $(row.insertCell(-1));
                cell.html(txt04.val());

                //Add Button cell.
                cell = $(row.insertCell(-1));
                var btnRemove = $("<input />");
                btnRemove.attr("type", "button");
                btnRemove.attr("onclick", "removeRow(this);");
                btnRemove.val("Remove");
                cell.append(btnRemove);

                //Clear the input control values
                txt01.val("");
                txt02.val("");
                $("#curriculumDDL").val("1").change();
                txt04.val("");

                //now there is something to save
                $("#btnSave").prop('disabled', false);
            }
        });

        //If new Semester data complete enable save button
        $("body").on("blur", ".semInputClass", function () {
            if (
                $('#txtSemesterCode').val().length > 0 &&
                $('#txtSemesterName').val().length > 0 &&
                $('#txtNumberOfVideoSessions').val().length > 0
            ) {
                $("#btnSave").prop('disabled', false);
            }
        });

        $("body").on("input", ".semInputClass", function () {
            if (
                $('#txtSemesterCode').val().length > 0 &&
                $('#txtSemesterName').val().length > 0 &&
                $('#txtNumberOfVideoSessions').val().length > 0
                ) {
                    $("#btnSave").prop('disabled', false);
                }
        });


        //Save all added rows
        $("body").on("click", "#btnSave", function () {

            //Loop through the Table rows and build a JSON array.
            var semesters = new Array();
            var exitNow;

            $("#tblMain TFOOT TR").each(function () {
                var row = $(this);
                var semCore = {};
                exitNow = false;

                //push new rows to the add list
                if (row.find('td:last-child').html().includes('value="Remove"')) {
                    //These rows already validated
                    semCore.SemesterCode= row.find("TD").eq(0).html();
                    semCore.SemesterName = row.find("TD").eq(1).html();
                    //semCore.curriculumName = row.find("TD").eq(2).html();
                    semCore.CurriculumId = parseInt(curriculumTextArray.indexOf(row.find("TD").eq(2).html()));
                    semCore.NumberOfVideoSessions = parseInt(row.find("TD").eq(3).html());
                    semesters.push(semCore);
                }
                //Row Added but not saved
                if (row.find('td:last-child').html().includes('value="Add Another"')) {

                    // get values of the candidate object
                    semCore.SemesterCode = row.find("input").eq(0).val();
                    semCore.SemesterName = row.find("input").eq(1).val();
                    semCore.CurriculumId = parseInt(curriculumTextArray.indexOf(row.find("select option:selected").text()));
                    nvsString = row.find("input").eq(2).val();

                    //if all blank, ingore it
                    if (semCore.SemesterCode.length > 0 ||
                        semCore.SemesterName.length > 0 ||
                        nvsString.length > 0) {
                        //if some blanks fix it
                        if (semCore.SemesterCode.length == 0 ||
                            semCore.SemesterName.length == 0 ||
                            nvsString.length == 0) {
                            alert('Please populate all ' + pageOjectLabel + ' fields before saving data.');
                            exitNow = true;
                        }
                        //validate nvs
                        else if (!digitsOnly(nvsString)) {
                            exitNow = true;
                            alert("The Number Of Video Sessions must be number. Please correct this before proceeding.");
                        }
                        //all is good, push it
                        else {
                            semCore.NumberOfVideoSessions = parseInt(nvsString);
                            semesters.push(semCore);
                        }
                    }
                }
            });

            if (!exitNow)  {

                //Send the JSON array to Controller using AJAX.
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("InsertSemesters","Cores")',
                    data: JSON.stringify(semesters),
                    dataType: 'JSON',
                    cache: false,
                    contentType: "application/json; charset=utf-8",
                    success: function (r) {
                    alert(r + " " + pageOjectLabel + "(s) inserted.");
                    }
                });

                //Give the db a minute to recognize the new records
                waitSeconds(delayMils);

                //Refresh the page
                refreshMe();
            }
        });

        //Delete item via AJAX
        deleteItem = function (itemId, button) {

            //Determine the reference of the calling Row
            var row = $(button).closest("TR");
            var name = $("TD", row).eq(1).html().trim();

            if (confirm("Do you want to delete Semester: " + name + " ?")) {
                //Get the reference of the Table.
                var table = $("#tblMain")[0];
                var itemArray = new Array;
                itemArray[0] = itemId;

                $.ajax({
                    type: "POST",
                    url: '@Url.Action("deleteSemesters","Cores")',
                    data: JSON.stringify(itemArray),
                    dataType: 'JSON',
                    cache: false,
                    contentType: "application/json; charset=utf-8",
                    success: function (r) {
                        alert(r + " " + pageOjectLabel + "(s) have been deleted.");
                    }
                });

                //Give the db a minute to recognize the new records
                waitSeconds(delayMils);
                //Refresh the page
                refreshMe();
            }
        }

        //Edit an org
        //function editItem(itemId, button) {
        editItem = function (itemId, button) {

            var editRow = $(button).closest("TR");
            var selectedVal;

            //Set up Save Changes button
            changeSaveButton(buttonType.SAVECHANGES, itemId);

            //Hide edit row
            editRow.hide();

            //set up the curriculum ddl
            $("#currDDL").html(ddlCode);

            selectedVal = editRow.find("TD").eq(2).html().trim();

            //Copy current values to the edit controls
            $('#txtSemesterCode').val(editRow.find("TD").eq(0).html().trim());
            $('#txtSemesterCode').prop('disabled', true);

            $('#txtSemesterName').val(editRow.find("TD").eq(1).html().trim());
            $("#curriculumDDL").val(curriculumTextArray.indexOf(selectedVal)).change();
            $('#txtNumberOfVideoSessions').val(editRow.find("TD").eq(3).html().trim()); curriculum

            //Show footer
            $("#trSaveAll").attr("hidden", true);
            //$("#btnCancel").attr("hidden", false);

            $("#tblMain TFOOT").attr("hidden", false);
            //scroll to bottom
            $("html, body").animate({ scrollTop: $(document).height() }, 1000);
        }

        //Save edits via ajax
        $("body").on("click", "#btnSaveEdit", function () {
            var row = $("#tblMain TFOOT TR:first");
            var semCore = {};
            var exitNow = false;

            // get values of the candidate object
            semCore.SemesterCode = row.find("input").eq(0).val();
            semCore.SemesterName = row.find("input").eq(1).val();
            //convert the curriculumName to curriculumID
            semCore.CurriculumId = parseInt(curriculumTextArray.indexOf(row.find("select option:selected").text()));
            nvsString = row.find("input").eq(2).val();

            //if all blank, post 'use Delete' message
            if (semCore.SemesterCode.length > 0 ||
                semCore.SemesterName.length > 0 ||
                nvsString.length > 0) {
                //if some blanks fix it
                if (semCore.SemesterCode.length == 0 ||
                    semCore.SemesterName.length == 0 ||
                    nvsString.length == 0) {
                    alert('Please populate all ' + pageOjectLabel + ' fields before saving changes.');
                    exitNow = true;
                }
                //validate nvs
                else if (!digitsOnly(nvsString)) {
                    alert("The Number Of Video Sessions must be number. Please correct this before proceeding.");
                    exitNow = true;
                }
            }
            // all were blank
            else {
                alert("Please populate the " + pageOjectLabel + " fields or use 'Delete' to remove a row.");
                exitNow = true;
            }

            if (!exitNow) {
                semCore.NumberOfVideoSessions = parseInt(nvsString);
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("UpdateSemester","Cores")',
                    data: JSON.stringify(semCore),
                    dataType: 'JSON',
                    cache: false,
                    contentType: "application/json; charset=utf-8",
                    success: function (r) {
                        alert(r + " SemesterCore(s) have been modified.");
                    }
                });

                //Give the db a minute to recognize the new records
                waitSeconds(delayMils);
                //Refresh the page
                refreshMe();
            }
        });

    /*end document.ready*/
    });

        </script>

</body>
</html>
